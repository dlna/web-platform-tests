<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Manual-player instantiation example</title>

    <script src="app/lib/dashjs/dash.debug.js"></script>
    <!--dash.all.min.js should be used in production over dash.all.debug.js
        Debug files are not compressed or obfuscated making the file size much larger compared with dash.all.min.js-->
    <!--<script src="app/lib/dashjs/dash.all.js"></script>-->

    <!-- Source HTTP server local copy of World Wide Web Consortium (W3C)
    Test Harness. -->
    <script src="../resources/testharness.js"></script>
    <script src="../resources/testharnessreport.js"></script>

     <!-- Test functions -->
    <script src="app/test-streams.js"></script>
    <script src="app/test-machine.simple.js"></script>

    <script>
        window.onload = function ()
        {
            var video, player, context, url;
            var sessionId = btoa(JSON.stringify(
                    {
                        "auth": "123",
                        "overide": {
                            "profile": {
                                "rental" : {
                                    "absoluteExpiration" : "2014-07-18T12:15:24Z",
                                    "playDuration" : 360000
                                }
                            }
                        }
                    }
                ));
            var drmTodayData = btoa(JSON.stringify(
                    {
                        "userId": "drm-test@example.com",
                        "sessionId": sessionId,
                        "merchant": "global_dnla"
                    }
                ));
            var protData = {
                    "com.widevine.alpha":{
                        "drmtoday":true,
                        "serverURL":"https://lic.staging.drmtoday.com/license-proxy-widevine/cenc/",
                        "httpRequestHeaders":{ "dt-custom-data":drmTodayData }
                    },
                    "com.microsoft.playready":{
                        "drmtoday":true,
                        "serverURL":"https://lic.staging.drmtoday.com/license-proxy-headerauth/drmtoday/RightsManager.asmx",
                        "httpRequestHeaders":{
                            "http-header-CustomData":drmTodayData
                        }
                    }
                };

            url = selectStream(window.location.pathname, "title");

            video = document.querySelector("video");

            context = new Dash.di.DashContext();
            player = new MediaPlayer(context);
            player.startup();
            player.attachView(video);
            player.attachVideoContainer(document.getElementById("videoContainer"));
            player.setAutoPlay(true);
            player.attachSource(url, null, protData);
            player.setAutoSwitchQuality(true);

            var sequence = [
                TestMachine.START,

                // Set the session type
                TestMachine.SET_TEMPORARY_SESSION,

                // Start the player
                TestMachine.GET_STREAMS,
                TestMachine.SET_STREAM,
                TestMachine.GET_LICENSE,
                TestMachine.WAIT_FOR_LICENSE,
                TestMachine.START_PLAY_LICENSE,

                // Run the tests
                TestMachine.CHECK_KEYSTATUS,
                TestMachine.CHECK_SESSION_TYPE,
                TestMachine.CHECK_PLAYING,
                TestMachine.CHECK_DURATION,

                TestMachine.SEEK_TIME,

                TestMachine.CHECK_ENDED,
                TestMachine.CHECK_END_TIME,
                TestMachine.CHECK_NEEDKEY_GREATER,
                TestMachine.END
            ];

            var testParameters = {
                "videoUrl": url,
                "keysNeededGreater": 0, // TODO: Set the minimum number of need key events
                "sessionType": "temporary", // TODO: Set the expected session type
                "seekStart": 2.0, // TODO: Set the start time for the seek
                "seekEnd": 31.002666, // TODO: Set the end time for the seek
                "duration": 33.002666, // TODO: Set the expected duration for the test stream
                "durationRange": 0.5, // TODO: Set the tollerance for the reported duration
                "endTime": 33.002666, // TODO: Set the expected end time for the test stream
                "endRange": 0.5 // TODO: Set the tollerance for the reported end time
            }

            // TODO: Set the 2nd parameter to the number of seconds before timing out the tests
            var testMachine = new TestMachine(sequence, 35.0, testParameters, video);
            testMachine.runTests();
        }
    </script>

    <style>
        video {
            width: 640px;
            height: 360px;
            align: center;
        }
    </style>

    <body>
        <h1 id="title">Simple DRM content playback</h1>
        <div id="videoContainer">
            <video controls="true">
            </video>
        </div>
    </body>
</html>
